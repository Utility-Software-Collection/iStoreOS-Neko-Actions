name: ğŸ’¿ St1_Build-Rootfs-release
on:
  workflow_dispatch:
    inputs:
      network_settings:
        description: "è¯·é€‰æ‹©åˆå§‹ç½‘ç»œé…ç½®"
        required: true
        default: 'dhcp'
        type: choice
        options:
          - 'static'
          - 'dhcp'
      ipaddr:
        description: 'è¯·è¾“å…¥ç®¡ç†IPï¼ˆé™æ€åœ°å€æ—¶å¿…å¡«ï¼‰'
        required: true
        default: '192.168.5.88'
      gateway:
        description: 'è¯·è¾“å…¥é»˜è®¤ç½‘å…³ï¼ˆé™æ€åœ°å€æ—¶å¿…å¡«ï¼‰'
        required: true
        default: '192.168.5.1'
      include_docker:
        description: "æ˜¯å¦é›†æˆDockeræ’ä»¶"
        required: true
        default: 'yes'
        type: choice
        options:
          - 'yes'
          - 'no'
      include_nikki:
        description: "æ˜¯å¦é›†æˆ OpenWrt-nikki (é€æ˜ä»£ç†æ’ä»¶)"
        required: true
        default: 'no' 
        type: choice
        options:
          - 'yes'
          - 'no'

      include_openclash:
        description: "æ˜¯å¦é›†æˆ OpenClash ä»£ç†æ’ä»¶"
        required: true
        default: 'no'
        type: choice
        options:
          - 'yes'
          - 'no'

env:
  VERSION: 24.10.3

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: âš™ï¸ è®¾ç½®å¯æ‰§è¡Œæƒé™
      run: | 
        chmod +x arm64/build24.sh
        chmod +x shell/*.sh

    - name: âš™ï¸ è®¾ç½®IPå’Œç½‘å…³
      run: |
        echo "å½“å‰ç½‘ç»œé…ç½®è·¯å¾„"
        CONFIG_PATH="./files/etc/uci-defaults/99-custom.sh"
        echo $CONFIG_PATH
        if [ "${{ inputs.network_settings }}" = "static" ]; then
           echo "åˆ é™¤ç½‘ç»œè®¾ç½®-dhcp"
           sed -i '44,105d' "$CONFIG_PATH"
           echo "æ›¿æ¢é»˜è®¤é…ç½®"
           sed -i "/ipaddr/s/192.168.5.88/${{ inputs.ipaddr }}/g" "$CONFIG_PATH"
           sed -i "/gateway/s/192.168.5.1/${{ inputs.gateway }}/g" "$CONFIG_PATH"
        else
           echo "åˆ é™¤ç½‘ç»œè®¾ç½®-static"
           sed -i '36,42d' "$CONFIG_PATH"
        fi
        echo "è¾“å‡ºé…ç½®"
        cat $CONFIG_PATH

    - name: â¬ å®‰è£…ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libncurses5-dev zstd curl unzip tree

    - name: â¬ ä¸‹è½½ ImageBuilder
      run: |
        curl -L -o imagebuilder.tar.zst https://github.com/Kwonelee/iStoreOS-Actions/releases/download/iStoreOS-ImageBuilder-20251017/istoreos-imagebuilder-armsr-armv8.Linux-x86_64.tar.zst
        tar --use-compress-program=unzstd -xvf imagebuilder.tar.zst
        mv istoreos-imagebuilder-* imagebuilder

    - name: â¬ å¤åˆ¶å¹¶è®¾ç½®å¿…å¤‡æ–‡ä»¶
      run: |
        cp arm64/{build24.sh,Makefile} imagebuilder/
        #cp arm64/repositories.conf imagebuilder/
        cp shell/{prepare-packages.sh,custom-packages.sh} imagebuilder/
        find files/packages/ -name "*.ipk" -exec cp {} imagebuilder/packages/ \;
        
        mkdir -p imagebuilder/files/etc/{uci-defaults,opkg,banner1}
        #æ·»åŠ å¼€æœºå¯åŠ¨è„šæœ¬
        cp files/etc/uci-defaults/99-custom.sh imagebuilder/files/etc/uci-defaults/
        #æ›¿æ¢Oå¤§æ‰“åŒ…è„šæœ¬çš„é»˜è®¤banner
        cp files/etc/banner imagebuilder/files/etc/banner1/
        mkdir -p imagebuilder/files/etc/openclash/core
        cp files/etc/openclash/core/clash_meta imagebuilder/files/etc/openclash/core/
        #ä¸´æ—¶è§£å†³é€šè¿‡æ™¶æ™¨å®ç›’å†™å…¥emmcåæ ¹åˆ†åŒºå˜ä¸ºåªè¯»çŠ¶æ€é—®é¢˜
        cp files/etc/rc.local imagebuilder/files/etc/
        
        cd imagebuilder
        echo "å¯ç”¨rootfs.tar.gzé…ç½®å¹¶åœç”¨éå¿…è¦é…ç½®"
        sed -i 's/# CONFIG_TARGET_ROOTFS_TARGZ is not set/CONFIG_TARGET_ROOTFS_TARGZ=y/' .config
        sed -i "s|CONFIG_TARGET_ROOTFS_SQUASHFS=.*|# CONFIG_TARGET_ROOTFS_SQUASHFS is not set|g" .config
        sed -i "s|CONFIG_TARGET_IMAGES_GZIP=.*|# CONFIG_TARGET_IMAGES_GZIP is not set|g" .config
        echo "æ‰“å°actionç›®å½•ç»“æ„"
        tree -L 1

    - name: â• é›†æˆ OpenWrt-nikki å¥—ä»¶åº«
      if: ${{ inputs.include_nikki == 'yes' }} 
      working-directory: ./imagebuilder
      run: |
        # è¨­ç½®è®Šæ•¸
        NIKKI_TAG="v1.24.2"
        # ç”±æ–¼ OECT/RK3566 å±¬æ–¼ ARMv8 (aarch64)ï¼Œä¸” iStoreOS å¸¸åŸºæ–¼ OpenWrt 23.05+
        ARCH_OWRT="aarch64_cortex-a53-openwrt-23.05"
        FILENAME="nikki_${ARCH_OWRT}.tar.gz"
        DOWNLOAD_URL="https://github.com/nikkinikki-org/OpenWrt-nikki/releases/download/${NIKKI_TAG}/${FILENAME}"
        PACKAGE_DIR="packages" # ImageBuilder æœƒåœ¨é€™å€‹ç›®éŒ„å°‹æ‰¾ .ipk æ–‡ä»¶

        echo "æ­£åœ¨å¾ ${DOWNLOAD_URL} ä¸‹è¼‰ Nikki æ’ä»¶åŒ…..."
        
        # 1. ä¸‹è¼‰å°æ‡‰æ¶æ§‹çš„é ç·¨è­¯å¥—ä»¶åŒ… (åŒ…å«æ‰€æœ‰ .ipk æ–‡ä»¶)
        curl -L ${DOWNLOAD_URL} -o ${FILENAME}

        # æª¢æŸ¥ä¸‹è¼‰æ˜¯å¦æˆåŠŸ
        if [ $? -ne 0 ] || [ ! -s "${FILENAME}" ]; then
          echo "âŒ ä¸‹è¼‰ Nikki æ’ä»¶åŒ…å¤±æ•—ï¼Œè«‹æª¢æŸ¥ URL æˆ–æ–‡ä»¶æ˜¯å¦ç‚ºç©ºã€‚"
          exit 1
        fi

        # 2. è§£å£“å¥—ä»¶åˆ° ImageBuilder çš„ packages ç›®éŒ„
        mkdir -p ${PACKAGE_DIR}
        tar -xzf ${FILENAME} -C ${PACKAGE_DIR}
        rm ${FILENAME}
        
        echo "âœ… Nikki æ’ä»¶åŒ…å·²æˆåŠŸä¸‹è¼‰ä¸¦è§£å£“è‡³ ${PACKAGE_DIR}"
        
        # 3. é€éä¿®æ”¹ .config æª”æ¡ˆä¾†ã€Œé¸ä¸­ã€æ‰€éœ€æ’ä»¶
        # é€™äº›é…ç½®é …æœƒè®“ ImageBuilder çŸ¥é“è¦å¾ packages ç›®éŒ„ä¸­é¸ä¸­å®ƒå€‘
        echo "CONFIG_PACKAGE_nikki=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-nikki=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-nikki-zh-cn=y" >> .config
        
        # 4. é¸ä¸­å¸¸è¦‹å¿…è¦ä¾è³´ (ç¢ºä¿åŸºç¤å¥—ä»¶å­˜åœ¨)
        echo "CONFIG_PACKAGE_ip-full=y" >> .config
        echo "CONFIG_PACKAGE_curl=y" >> .config
        echo "CONFIG_PACKAGE_yq=y" >> .config

        echo "âœ… Nikki å¥—ä»¶å·²æ·»åŠ åˆ°é…ç½®æ¸…å–®ä¸­"

    - name: â• é›†æˆ OpenClash æ’ä»¶
      # âš ï¸ åˆ¤æ–·é‚è¼¯ï¼šåªæœ‰åœ¨é¸æ“‡ OpenClash ä¸”æ²’é¸ Nikki æ™‚æ‰åŸ·è¡Œ
      if: ${{ inputs.include_openclash == 'yes' && inputs.include_nikki == 'no' }} 
      working-directory: ./imagebuilder
      run: |
        OPENCLASH_REPO="vernesong/OpenClash"
        
        # 1. æŸ¥è©¢æœ€æ–°çš„ Release Tag (ä¾‹å¦‚ v0.47.010)
        OPENCLASH_TAG=$(curl -s "https://api.github.com/repos/${OPENCLASH_REPO}/releases/latest" | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
        
        # å¾ Tag ä¸­æå–ç‰ˆæœ¬è™Ÿï¼Œç§»é™¤é–‹é ­çš„ 'v'
        VERSION_NUMBER=${OPENCLASH_TAG#v}

        # 2. æ§‹å»ºç²¾ç¢ºçš„ IPK æ–‡ä»¶åå’Œä¸‹è¼‰ URL
        IPK_FILENAME="luci-app-openclash_${VERSION_NUMBER}_all.ipk"
        DOWNLOAD_URL="https://github.com/vernesong/OpenClash/releases/download/${OPENCLASH_TAG}/${IPK_FILENAME}"
        
        echo "æœ€æ–°ç‰ˆæœ¬ OpenClash Tag: ${OPENCLASH_TAG}"
        echo "æ­£åœ¨ä¸‹è¼‰ OpenClash IPK: ${DOWNLOAD_URL}"
        
        # 3. ä¸‹è¼‰ IPK æ–‡ä»¶
        curl -L "${DOWNLOAD_URL}" -o "${IPK_FILENAME}"

        # 4. æª¢æŸ¥ä¸‹è¼‰æ˜¯å¦æˆåŠŸ
        if [ $? -ne 0 ] || [ ! -s "${IPK_FILENAME}" ]; then
          echo "âŒ OpenClash IPK ä¸‹è¼‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ–‡ä»¶åï¼š${IPK_FILENAME} æˆ– Release URLã€‚"
          exit 1
        fi

        # 5. è¤‡è£½ IPK åˆ° ImageBuilder çš„ packages ç›®éŒ„
        cp "${IPK_FILENAME}" ./packages/
        rm "${IPK_FILENAME}"
        
        echo "âœ… OpenClash IPK å·²æˆåŠŸè¤‡è£½åˆ° packages ç›®éŒ„"
        
        # 6. é¸ä¸­æ‰€éœ€æ’ä»¶åˆ°é…ç½®
        echo "CONFIG_PACKAGE_luci-app-openclash=y" >> .config
        
        echo "âœ… OpenClash å¥—ä»¶å·²é›†æˆ"
    
    - name: ğŸ§± æ„å»ºiStoreOS-rootfs
      working-directory: ./imagebuilder
      run: |
        echo "æ‰“å°imagebuilderç›®å½•ç»“æ„"
        tree -L 1
        echo "æ‰“å°repositories"
        cat repositories.conf
        echo "æ‰“å°Makefile"
        cat Makefile |grep here
        bash ./build24.sh

    - name: ğŸ“¦ æ‰“å°äº§å‡ºrootfs
      run: |
        echo "æ‰“å°binç›®å½•"
        ls -lah imagebuilder/bin/targets/armsr/armv8/

    - name: â¬†ï¸ ä¸Šå‚³ Rootfs åˆ°å·¥ä½œæµç”¢ç‰© (Artifact)
      uses: actions/upload-artifact@v4
      with:
        name: iStoreOS-Rootfs-Base-${{ env.VERSION }}-${{ inputs.network_settings }}
        path: imagebuilder/bin/targets/armsr/armv8/*generic-rootfs.tar.gz

    - name: ğŸš€ ä¸Šä¼ åˆ° Release
      uses: softprops/action-gh-release@v2.2.1
      with:
        tag_name: iStoreOS-${{ env.VERSION }}-RELEASE-${{ inputs.network_settings }}
        body: |
          ğŸ“Œ ç‰ˆæœ¬ï¼š iStoreOS-${{ env.VERSION }}-RELEASEï¼ˆimagebuilderæ„å»ºï¼Œç¨³å®šç‰ˆï¼‰
          
          ğŸ“‚ æ¥æºï¼š https://fw.koolcenter.com/iStoreOS/ib/armsr/
          
          ğŸ§  å†…æ ¸ï¼š Please Login to iStoreOS â†’ System â†’ Amlogic Service â†’ Replace the Kernel
          
          ğŸ§© é›†æˆï¼š åŒ…å«äº†åŸºç¡€ç³»ç»Ÿç»„ä»¶ã€é©±åŠ¨ã€ç½‘ç»œå·¥å…·ã€å®¹å™¨æ”¯æŒã€LuCIç•Œé¢åŠæ’ä»¶ç­‰ã€‚ä¸å®˜æ–¹é›†æˆåˆ—è¡¨åŸºæœ¬ä¸€è‡´
          
          ğŸ‘¤ ç”¨æˆ·åï¼š root
          
          ğŸ”’ å¯†ç ï¼š æ— 
          
          ğŸŒ IPï¼š ${{ inputs.network_settings == 'static' && inputs.ipaddr || 'å•ç½‘å£-åŠ¨æ€è·å–ï¼ˆä»ä¸Šçº§è·¯ç”±æ‰¾å¯»ï¼‰ï¼›å¤šç½‘å£-IPï¼š192.168.100.1' }}
        files: |
          imagebuilder/bin/targets/armsr/armv8/*generic-rootfs.tar.gz
      env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
